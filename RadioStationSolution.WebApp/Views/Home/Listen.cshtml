@model OnlineRadioStation.Domain.RadioStationEntity
@using System.Collections.Generic
@using Microsoft.AspNetCore.Http
@inject OnlineRadioStation.Services.IUserService _userService
@{
    ViewData["Title"] = $"–ï—Ñ—ñ—Ä: {Model.StationName}";
    var playlistForJs = new List<object>();
    bool isOffline = ViewBag.IsOffline ?? true;
    var userRatings = ViewBag.UserRatings as Dictionary<Guid, int> ?? new Dictionary<Guid, int>();

    if (!isOffline)
    {
        var tracksList = ViewBag.OrderedPlaylist as List<OnlineRadioStation.Domain.Track>;

        if (tracksList != null)
        {
            OnlineRadioStation.Domain.IPlaylistIterator iterator =
                new OnlineRadioStation.Domain.PlaybackQueueIterator(tracksList);

            iterator.First();
            int position = 1;

            while (!iterator.IsDone())
            {
                var track = iterator.Current();

                if (!string.IsNullOrEmpty(track.HlsUrl))
                {
                    int rating = userRatings.ContainsKey(track.TrackId) ? userRatings[track.TrackId] : 0;
                    var votes = _userService.GetTrackVotesAsync(track.TrackId).Result;
                    playlistForJs.Add(new {
                        trackId = track.TrackId.ToString(),
                        title = track.Title,
                        url = track.HlsUrl,
                        id = position,
                        userRating = rating,
                        likesCount = votes.Likes,
                        dislikesCount = votes.Dislikes
                    });
                    position++;
                }

                iterator.Next();
            }
        }
    }
}

<style>
    body {
        background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        color: #fff;
        min-height: 100vh;
        font-family: 'Segoe UI', sans-serif;
    }

    .station-header h1 {
        font-weight: 900;
        letter-spacing: -1px;
        text-shadow: 0 0 20px rgba(255, 75, 135, 0.6);
    }

    .station-header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        transition: all 0.4s ease;
    }

    .card:hover {
        box-shadow: 0 15px 35px rgba(255, 75, 135, 0.25);
        transform: translateY(-5px);
    }

    #currentTrackName {
        font-size: 1.7rem;
        font-weight: 700;
        background: linear-gradient(90deg, #ff4b87, #ff8b87);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .btn-danger {
        background: linear-gradient(45deg, #ff0844, #ffb199);
        border: none;
        box-shadow: 0 10px 30px rgba(255, 8, 68, 0.4);
    }

    .btn-danger:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 40px rgba(255, 8, 68, 0.6);
    }

    .btn-success { background: #28a745 !important; border: none; }
    .btn-danger.active { background: #dc3545 !important; border: none; }

    .spinner-grow {
        animation: pulse 1.5s infinite;
    }

    @@keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }

    .live-badge {
        animation: glow 2s ease-in-out infinite alternate;
    }

    @@keyframes glow {
        from { text-shadow: 0 0 10px #ff0844; }
        to { text-shadow: 0 0 25px #ff0844, 0 0 35px #ff0844; }
    }

    .rating-btn {
        transition: all 0.3s ease;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .rating-btn:hover {
        transform: translateY(-4px);
        background: rgba(255,255,255,0.2);
    }

    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>

<div class="container mt-5 text-center">
    <div class="station-header mb-5">
        <h1 class="display-3 fw-bold">@Model.StationName</h1>
        <p class="lead text-white-50 mt-3">@Model.Description</p>
        <hr class="w-25 mx-auto opacity-50" style="border-top: 2px solid #ff4b87;" />
    </div>

    <div id="offlineView" class="py-5" style="@(isOffline ? "" : "display:none;")">
        <i class="bi bi-broadcast text-secondary opacity-50" style="font-size: 7rem;"></i>
        <h2 class="mt-4 text-white-50 fw-light">–ï—Ñ—ñ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–æ</h2>
        <p class="text-white-50">–î—ñ–¥–∂–µ–π –≤–∂–µ –ø—ñ—à–æ–≤ —Å–ø–∞—Ç–∏. –ü–æ–≤–µ—Ä–Ω–µ–º–æ—Å—è —Å–∫–æ—Ä–æ!</p>
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-light btn-lg mt-4 px-5 rounded-pill">
            <i class="bi bi-house-door me-2"></i>–ù–∞ –≥–æ–ª–æ–≤–Ω—É
        </a>
    </div>

    <div id="onlineView" style="@(isOffline ? "display:none;" : "")">

        <div id="playOverlay" class="py-5" style="display:none;">
            <div class="mb-5">
                <div class="spinner-grow text-danger live-badge" role="status" style="width: 1.2rem; height: 1.2rem;"></div>
                <span class="text-danger fw-bold ms-3 fs-3 live-badge">LIVE</span>
            </div>
            <button id="btnStartRadio" class="btn btn-danger btn-lg rounded-circle shadow-lg border-0" style="width: 100px; height: 100px;">
                <i class="bi bi-play-fill" style="font-size: 3rem; margin-left: 6px;"></i>
            </button>
            <p class="mt-4 text-white-50 fs-5">–ù–∞—Ç–∏—Å–Ω–∏ ‚Äî —ñ –≤ –µ—Ñ—ñ—Ä!</p>
        </div>

        <div id="playerContainer" style="display:none;" class="py-5">
            <div class="card shadow-lg mx-auto border-0" style="max-width: 560px;">
                <div class="card-body text-center py-5">
                    <h3 id="currentTrackName" class="mb-4">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h3>

                    <div class="d-flex justify-content-center align-items-center gap-5 mb-4">
                        <button id="btnDislike" class="rating-btn rounded-circle p-4 d-flex flex-column align-items-center justify-content-center" style="width: 80px; height: 80px;" onclick="rateTrack(false)">
                            <i id="iconDislike" class="bi bi-hand-thumbs-down fs-3"></i>
                            <span id="countDislike" class="small fw-bold mt-1" style="font-size: 0.8rem;"></span>
                        </button>

                        <button id="btnLike" class="rating-btn rounded-circle p-4 d-flex flex-column align-items-center justify-content-center" style="width: 80px; height: 80px;" onclick="rateTrack(true)">
                            <i id="iconLike" class="bi bi-hand-thumbs-up fs-3"></i>
                            <span id="countLike" class="small fw-bold mt-1" style="font-size: 0.8rem;"></span>
                        </button>
                    </div>

                    <p class="text-white-50 small mb-0">
                        <i class="bi bi-broadcast-fill text-danger live-badge"></i>
                        –í–∏ —Å–ª—É—Ö–∞—î—Ç–µ –ø—Ä—è–º–∏–π –µ—Ñ—ñ—Ä
                    </p>

                    <div class="mt-4">
                        <button onclick="toggleMute()" class="btn btn-link text-white-50 text-decoration-none">
                            <i id="muteIcon" class="bi bi-volume-up-fill fs-4"></i>
                        </button>
                        <audio id="audioPlayer" style="width: 0; height: 0;"></audio>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="csrf-form" style="display:none;">@Html.AntiForgeryToken()</form>

@section Scripts {
    <script>
        // === –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ===
        var stationId = '@Model.StationId';
        
        // –ö–µ—à—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        var dom = {
            audio: document.getElementById('audioPlayer'),
            btnStart: document.getElementById('btnStartRadio'),
            overlay: document.getElementById('playOverlay'),
            playerContainer: document.getElementById('playerContainer'),
            offlineView: document.getElementById('offlineView'),
            onlineView: document.getElementById('onlineView'),
            trackLabel: document.getElementById('currentTrackName'),
            btnLike: document.getElementById('btnLike'),
            btnDislike: document.getElementById('btnDislike'),
            likesCount: document.getElementById('countLike'),
            dislikesCount: document.getElementById('countDislike')
        };

        // –°—Ç–∞–Ω –∫–ª—ñ—î–Ω—Ç–∞
        var state = {
            hls: null,
            isPlayingLive: false,
            currentTrackId: null,
            wasOffline: @(isOffline ? "true" : "false")
        };

        // === 1. –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–Ø (UI) ===
        
        // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—ñ–≤ –µ–∫—Ä–∞–Ω—É (–û—Ñ–ª–∞–π–Ω / –û–≤–µ—Ä–ª–µ–π / –ü–ª–µ—î—Ä)
        function setViewMode(mode) {
            if (mode === 'offline') {
                dom.onlineView.style.display = 'none';
                dom.offlineView.style.display = 'block';
                return;
            }
            // Online mode
            dom.offlineView.style.display = 'none';
            dom.onlineView.style.display = 'block';

            if (mode === 'overlay') {
                dom.overlay.style.display = 'block';
                dom.playerContainer.style.display = 'none';
            } else if (mode === 'player') {
                dom.overlay.style.display = 'none';
                dom.playerContainer.style.display = 'block';
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –ø–ª–µ—î—Ä–∞ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
        function updatePlayerUI(isLiveStream) {
            var badges = document.querySelectorAll('.live-badge');
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –±–ª–æ–∫-–æ–±–≥–æ—Ä—Ç–∫—É –∫–Ω–æ–ø–æ–∫ (div –∑ –∫–ª–∞—Å–æ–º d-flex...), —â–æ–± —Å—Ö–æ–≤–∞—Ç–∏ –≤—Å–µ —Ä–∞–∑–æ–º
            var ratingContainer = dom.btnLike ? dom.btnLike.parentElement : null;

            if (isLiveStream) {
                // === –†–ï–ñ–ò–ú LIVE (–ú—ñ–∫—Ä–æ—Ñ–æ–Ω) ===
                dom.trackLabel.innerHTML = "<span class='text-danger animate-pulse'>üî¥ –ü–†–Ø–ú–ò–ô –ï–§–Ü–† –ó–Ü –°–¢–£–î–Ü–á</span>";
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –±–µ–π–¥–∂—ñ LIVE
                badges.forEach(b => b.classList.remove('d-none'));
                
                // –ü–û–í–ù–Ü–°–¢–Æ –•–û–í–ê–Ñ–ú–û –ë–õ–û–ö –õ–ê–ô–ö–Ü–í
                if(ratingContainer) ratingContainer.style.display = 'none';
            } else {
                // === –†–ï–ñ–ò–ú AUTO-DJ (–¢—Ä–µ–∫–∏) ===
                // –•–æ–≤–∞—î–º–æ –±–µ–π–¥–∂—ñ LIVE
                badges.forEach(b => b.classList.add('d-none'));
                
                // –ü–û–í–ï–†–¢–ê–Ñ–ú–û –ë–õ–û–ö –õ–ê–ô–ö–Ü–í (flex, –±–æ —Ç–∞–º d-flex –∫–ª–∞—Å)
                if(ratingContainer) ratingContainer.style.display = 'flex';
            }
        }

        // === 2. –ê–£–î–Ü–û (HLS) ===

        function loadAudioSource(url, isLive) {
            console.log("Loading source: " + url + " [Live: " + isLive + "]");

            if (Hls.isSupported()) {
                if(state.hls) state.hls.destroy();
                state.hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                state.hls.loadSource(url);
                state.hls.attachMedia(dom.audio);
                
                state.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    dom.audio.play().catch(() => console.log("Autoplay blocked"));
                });
                
                state.hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        if(data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                            console.log("Network error, retrying...");
                            state.hls.startLoad();
                        } else {
                            state.hls.destroy();
                        }
                    }
                });
            } else if (dom.audio.canPlayType('application/vnd.apple.mpegurl')) {
                // –î–ª—è Safari
                dom.audio.src = url;
                dom.audio.play();
            }
            
            // –û–¥—Ä–∞–∑—É –æ–Ω–æ–≤–ª—é—î–º–æ UI (—Ö–æ–≤–∞—î–º–æ/–ø–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫–∏)
            updatePlayerUI(isLive);
        }

        // === 3. –õ–û–ì–Ü–ö–ê –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á ===

        async function checkRadioStatus() {
            try {
                // –î–æ–¥–∞—î–º–æ timestamp, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∫–µ—à—É–≤–∞–Ω–Ω—è JSON-–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                let response = await fetch('/Home/GetRadioStatus?stationId=' + stationId + '&t=' + Date.now());
                if (!response.ok) return;
                
                let status = await response.json();

                // –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –°—Ç–∞–Ω—Ü—ñ—è –ø—ñ—à–ª–∞ –≤ –æ—Ñ–ª–∞–π–Ω
                if (status.isOffline && !status.isLiveStream) {
                    if (dom.onlineView.style.display !== 'none') {
                        dom.audio.pause();
                        if(state.hls) { state.hls.destroy(); state.hls = null; }
                        
                        state.isPlayingLive = false;
                        state.currentTrackId = null;
                        
                        setViewMode('offline');
                    }
                    state.wasOffline = true;
                    return;
                }

                // –ê–í–¢–û-–†–ï–§–†–ï–®: –Ø–∫—â–æ –∑'—è–≤–∏–≤—Å—è –µ—Ñ—ñ—Ä –ø—ñ—Å–ª—è –æ—Ñ–ª–∞–π–Ω—É - –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç—É
                if (state.wasOffline) {
                    window.location.reload();
                    return;
                }

                // –Ø–∫—â–æ –ø–ª–µ—î—Ä —Å—Ö–æ–≤–∞–Ω–∏–π, –∞–ª–µ –º–∏ –æ–Ω–ª–∞–π–Ω - –ø–æ–∫–∞–∑—É—î–º–æ –π–æ–≥–æ
                if (dom.playerContainer.style.display === 'none' && dom.overlay.style.display === 'none') {
                    setViewMode('player');
                }

                // –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –ñ–∏–≤–∏–π –µ—Ñ—ñ—Ä (Live)
                if (status.isLiveStream) {
                    if (!state.isPlayingLive) {
                        console.log("Switching to LIVE...");
                        state.isPlayingLive = true;
                        state.currentTrackId = null;
                        
                        // nocache –¥–ª—è –º–∞–Ω—ñ—Ñ–µ—Å—Ç—É
                        loadAudioSource(status.liveUrl + "?nocache=" + Date.now(), true);
                        setViewMode('player');
                    }
                    // –ü—Ä–æ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫ –æ–Ω–æ–≤–ª—é—î–º–æ UI (—â–æ–± –∫–Ω–æ–ø–∫–∏ —Ç–æ—á–Ω–æ –∑–Ω–∏–∫–ª–∏)
                    updatePlayerUI(true);
                    return;
                }

                // –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –ó–≤–∏—á–∞–π–Ω–∏–π –ø–ª–µ–π–ª–∏—Å—Ç
                if (state.isPlayingLive) {
                    // –Ø–∫—â–æ –ª–∞–π–≤ –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è - –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ, —â–æ–± –∫–æ—Ä–µ–∫—Ç–Ω–æ –ø—ñ–¥—Ö–æ–ø–∏—Ç–∏ —Ç—Ä–µ–∫–∏
                    console.log("Live ended. Reloading...");
                    window.location.reload();
                    return;
                }

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ç—Ä–µ–∫—É
                if (status.startTrackId && status.startTrackId !== state.currentTrackId) {
                    var trackInfo = status.playlist.find(t => t.trackId === status.startTrackId);
                    if (trackInfo) {
                        state.currentTrackId = status.startTrackId;
                        dom.trackLabel.innerText = trackInfo.title;
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ URL (–±–µ–∑ query params), —â–æ–± –Ω–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ç–æ–π —Å–∞–º–∏–π —Ç—Ä–µ–∫
                        var currentSrc = state.hls ? state.hls.url : dom.audio.src;
                        if (!currentSrc || !currentSrc.includes(trackInfo.url.split('?')[0])) {
                             loadAudioSource(trackInfo.url, false);
                             if (status.startOffset > 0) dom.audio.currentTime = status.startOffset;
                        } else {
                            // –Ø–∫—â–æ —Ç—Ä–µ–∫ –≥—Ä–∞—î, –ø–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å, —â–æ –∫–Ω–æ–ø–∫–∏ –ª–∞–π–∫—ñ–≤ –í–ò–î–ò–ú–Ü
                            updatePlayerUI(false);
                        }
                        
                        updateButtons(trackInfo.userRating, trackInfo.likesCount, trackInfo.dislikesCount, trackInfo.trackId);
                    }
                }

            } catch (e) { console.error(e); }
        }

        // === 4. –ü–û–î–Ü–á ===

        dom.btnStart.addEventListener('click', function() {
            setViewMode('player');
            dom.audio.play().catch(e => {}); 
            checkRadioStatus(); 
        });

        // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª—É –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
        setInterval(checkRadioStatus, 5000);
        checkRadioStatus(); 

        // === 5. –§–£–ù–ö–¶–Ü–û–ù–ê–õ –ö–ù–û–ü–û–ö ===

        window.toggleMute = function() {
            dom.audio.muted = !dom.audio.muted;
            document.getElementById('muteIcon').className = dom.audio.muted ? "bi bi-volume-mute-fill fs-4" : "bi bi-volume-up-fill fs-4";
        };

        window.rateTrack = async function(isLike) {
            if(!state.currentTrackId) return;
            var token = document.querySelector('#csrf-form input').value;
            try {
                let response = await fetch(`/Home/RateTrack?trackId=${state.currentTrackId}&isLike=${isLike}`, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': token }
                });
                if (response.status === 401) { alert("–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –≥–æ–ª–æ—Å—É–≤–∞—Ç–∏!"); return; }
                if (response.ok) {
                    let data = await response.json();
                    updateButtons(data.status, data.likes, data.dislikes, state.currentTrackId);
                }
            } catch (e) {}
        };

        function updateButtons(status, likes, dislikes, trackId) {
            if(dom.btnLike) dom.btnLike.dataset.trackId = trackId;
            if(!dom.btnLike) return;

            // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ
            dom.btnLike.className = "rating-btn rounded-circle p-4 d-flex flex-column align-items-center justify-content-center";
            dom.btnDislike.className = "rating-btn rounded-circle p-4 d-flex flex-column align-items-center justify-content-center";
            document.getElementById('iconLike').className = "bi bi-hand-thumbs-up fs-3";
            document.getElementById('iconDislike').className = "bi bi-hand-thumbs-down fs-3";

            // –ê–∫—Ç–∏–≤—É—î–º–æ –Ω–∞—Ç–∏—Å–Ω—É—Ç—É –∫–Ω–æ–ø–∫—É
            if (status === 1) {
                dom.btnLike.classList.add('btn-success');
                document.getElementById('iconLike').className = "bi bi-hand-thumbs-up-fill fs-3";
            } else if (status === -1) {
                dom.btnDislike.classList.add('btn-danger', 'active');
                document.getElementById('iconDislike').className = "bi bi-hand-thumbs-down-fill fs-3";
            }
            
            dom.likesCount.innerText = likes > 0 ? likes : "";
            dom.dislikesCount.innerText = dislikes > 0 ? dislikes : "";
        }
    </script>
}