@model OnlineRadioStation.Domain.RadioStationEntity
@using System.Collections.Generic
@using Microsoft.AspNetCore.Http
@inject OnlineRadioStation.Services.IUserService _userService
@{
    ViewData["Title"] = $"–ï—Ñ—ñ—Ä: {Model.StationName}";
    var playlistForJs = new List<object>();
    bool isOffline = ViewBag.IsOffline ?? true;
    var userRatings = ViewBag.UserRatings as Dictionary<Guid, int> ?? new Dictionary<Guid, int>();

    if (!isOffline)
    {
        var tracksList = ViewBag.OrderedPlaylist as List<OnlineRadioStation.Domain.Track>;

        if (tracksList != null)
        {
            OnlineRadioStation.Domain.IPlaylistIterator iterator =
                new OnlineRadioStation.Domain.PlaybackQueueIterator(tracksList);

            iterator.First();
            int position = 1;

            while (!iterator.IsDone())
            {
                var track = iterator.Current();

                if (!string.IsNullOrEmpty(track.HlsUrl))
                {
                    int rating = userRatings.ContainsKey(track.TrackId) ? userRatings[track.TrackId] : 0;
                    var votes = _userService.GetTrackVotesAsync(track.TrackId).Result;
                    playlistForJs.Add(new {
                        trackId = track.TrackId.ToString(),
                        title = track.Title,
                        url = track.HlsUrl,
                        id = position,
                        userRating = rating,
                        likesCount = votes.Likes,
                        dislikesCount = votes.Dislikes
                    });
                    position++;
                }

                iterator.Next();
            }
        }
    }
}

<style>
    body {
        background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        color: #fff;
        min-height: 100vh;
        font-family: 'Segoe UI', sans-serif;
    }

    .station-header h1 {
        font-weight: 900;
        letter-spacing: -1px;
        text-shadow: 0 0 20px rgba(255, 75, 135, 0.6);
    }

    .station-header p {
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        transition: all 0.4s ease;
    }

    .card:hover {
        box-shadow: 0 15px 35px rgba(255, 75, 135, 0.25);
        transform: translateY(-5px);
    }

    #currentTrackName {
        font-size: 1.7rem;
        font-weight: 700;
        background: linear-gradient(90deg, #ff4b87, #ff8b87);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .btn-danger {
        background: linear-gradient(45deg, #ff0844, #ffb199);
        border: none;
        box-shadow: 0 10px 30px rgba(255, 8, 68, 0.4);
    }

    .btn-danger:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 40px rgba(255, 8, 68, 0.6);
    }

    .btn-success { background: #28a745 !important; border: none; }
    .btn-danger.active { background: #dc3545 !important; border: none; }

    .spinner-grow {
        animation: pulse 1.5s infinite;
    }

    @@keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }

    .live-badge {
        animation: glow 2s ease-in-out infinite alternate;
    }

    @@keyframes glow {
        from { text-shadow: 0 0 10px #ff0844; }
        to { text-shadow: 0 0 25px #ff0844, 0 0 35px #ff0844; }
    }

    .rating-btn {
        transition: all 0.3s ease;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .rating-btn:hover {
        transform: translateY(-4px);
        background: rgba(255,255,255,0.2);
    }
</style>

<div class="container mt-5 text-center">
    <div class="station-header mb-5">
        <h1 class="display-3 fw-bold">@Model.StationName</h1>
        <p class="lead text-white-50 mt-3">@Model.Description</p>
        <hr class="w-25 mx-auto opacity-50" style="border-top: 2px solid #ff4b87;" />
    </div>

    <div id="offlineView" class="py-5" style="@(isOffline ? "" : "display:none;")">
        <i class="bi bi-broadcast text-secondary opacity-50" style="font-size: 7rem;"></i>
        <h2 class="mt-4 text-white-50 fw-light">–ï—Ñ—ñ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–æ</h2>
        <p class="text-white-50">–î—ñ–¥–∂–µ–π –≤–∂–µ –ø—ñ—à–æ–≤ —Å–ø–∞—Ç–∏. –ü–æ–≤–µ—Ä–Ω–µ–º–æ—Å—è —Å–∫–æ—Ä–æ!</p>
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-light btn-lg mt-4 px-5 rounded-pill">
            <i class="bi bi-house-door me-2"></i>–ù–∞ –≥–æ–ª–æ–≤–Ω—É
        </a>
    </div>

    <div id="onlineView" style="@(isOffline ? "display:none;" : "")">

        <div id="playOverlay" class="py-5" style="display:none;">
            <div class="mb-5">
                <div class="spinner-grow text-danger live-badge" role="status" style="width: 1.2rem; height: 1.2rem;"></div>
                <span class="text-danger fw-bold ms-3 fs-3 live-badge">LIVE</span>
            </div>
            <button id="btnStartRadio" class="btn btn-danger btn-lg rounded-circle shadow-lg border-0" style="width: 100px; height: 100px;">
                <i class="bi bi-play-fill" style="font-size: 3rem; margin-left: 6px;"></i>
            </button>
            <p class="mt-4 text-white-50 fs-5">–ù–∞—Ç–∏—Å–Ω–∏ ‚Äî —ñ –≤ –µ—Ñ—ñ—Ä!</p>
        </div>

        <div id="playerContainer" style="display:none;" class="py-5">
            <div class="card shadow-lg mx-auto border-0" style="max-width: 560px;">
                <div class="card-body text-center py-5">
                    <h3 id="currentTrackName" class="mb-4">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h3>

                    <div class="d-flex justify-content-center align-items-center gap-5 mb-4">
                        <button id="btnDislike" class="rating-btn rounded-circle p-4 d-flex flex-column align-items-center justify-content-center" style="width: 80px; height: 80px;" onclick="rateTrack(false)">
                            <i id="iconDislike" class="bi bi-hand-thumbs-down fs-3"></i>
                            <span id="countDislike" class="small fw-bold mt-1" style="font-size: 0.8rem;"></span>
                        </button>

                        <button id="btnLike" class="rating-btn rounded-circle p-4 d-flex flex-column align-items-center justify-content-center" style="width: 80px; height: 80px;" onclick="rateTrack(true)">
                            <i id="iconLike" class="bi bi-hand-thumbs-up fs-3"></i>
                            <span id="countLike" class="small fw-bold mt-1" style="font-size: 0.8rem;"></span>
                        </button>
                    </div>

                    <p class="text-white-50 small mb-0">
                        <i class="bi bi-broadcast-fill text-danger live-badge"></i>
                        –í–∏ —Å–ª—É—Ö–∞—î—Ç–µ –ø—Ä—è–º–∏–π –µ—Ñ—ñ—Ä
                    </p>

                    <div class="mt-4">
                        <button onclick="toggleMute()" class="btn btn-link text-white-50 text-decoration-none">
                            <i id="muteIcon" class="bi bi-volume-up-fill fs-4"></i>
                        </button>
                        <audio id="audioPlayer" style="width: 0; height: 0;"></audio>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="csrf-form" style="display:none;">@Html.AntiForgeryToken()</form>

@section Scripts {
    <script>
        var stationId = '@Model.StationId';
        var audio = document.getElementById('audioPlayer');
        var btnStart = document.getElementById('btnStartRadio');
        var overlay = document.getElementById('playOverlay');
        var container = document.getElementById('playerContainer');
        var offlineView = document.getElementById('offlineView');
        var onlineView = document.getElementById('onlineView');
        var trackLabel = document.getElementById('currentTrackName');
        var btnLike = document.getElementById('btnLike');
        var btnDislike = document.getElementById('btnDislike');
        
        var hls = null;
        var isPlayingLive = false;
        var currentTrackId = null;

        // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –≤ —Ä–µ–∂–∏–º "–û–Ω–ª–∞–π–Ω"
        function uiGoOnline() {
            if (offlineView.style.display !== 'none') {
                offlineView.style.display = 'none';
                onlineView.style.display = 'block';
                // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É Play (–æ–≤–µ—Ä–ª–µ–π), —è–∫—â–æ –∞—É–¥—ñ–æ —â–µ –Ω–µ –≥—Ä–∞—î
                if (audio.paused) {
                    overlay.style.display = 'block';
                    container.style.display = 'none';
                }
            }
        }

        function loadAudioSource(url, isLive) {
            console.log("Loading source: " + url);

            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.loadSource(url);
                hls.attachMedia(audio);
                hls.on(Hls.Events.MANIFEST_PARSED, function () {
                    audio.play().catch(e => console.log("Autoplay blocked"));
                });
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        if(data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                            console.log("Network error, retrying...");
                            hls.startLoad();
                        } else {
                            hls.destroy();
                        }
                    }
                });
            } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
                audio.src = url;
                audio.play();
            }
            
            if (isLive) {
                trackLabel.innerHTML = "<span class='text-danger animate-pulse'>üî¥ –ü–†–Ø–ú–ò–ô –ï–§–Ü–† –ó–Ü –°–¢–£–î–Ü–á</span>";
                var badges = document.querySelectorAll('.live-badge');
                badges.forEach(b => b.classList.remove('d-none'));
                if(btnLike) btnLike.style.display = 'none';
                if(btnDislike) btnDislike.style.display = 'none';
            } else {
                var badges = document.querySelectorAll('.live-badge');
                badges.forEach(b => b.classList.add('d-none'));
                if(btnLike) btnLike.style.display = 'flex';
                if(btnDislike) btnDislike.style.display = 'flex';
            }
        }

        async function checkRadioStatus() {
            try {
                let response = await fetch('/Home/GetRadioStatus?stationId=' + stationId + '&t=' + Date.now());
                if (!response.ok) return;
                
                let status = await response.json();

                // 1. –ü–æ–≤–Ω–∞ —Ç–∏—à–∞ (–û—Ñ–ª–∞–π–Ω)
                if (status.isOffline && !status.isLiveStream) {
                    // –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –º–∏ —Ä–∞–Ω—ñ—à–µ –±—É–ª–∏ –æ–Ω–ª–∞–π–Ω
                    if (onlineView.style.display !== 'none') {
                        audio.pause();
                        onlineView.style.display = 'none';
                        offlineView.style.display = 'block';
                    }
                    return;
                }

                // –Ø–∫—â–æ –º–∏ —Ç—É—Ç, –∑–Ω–∞—á–∏—Ç—å –º–∏ –û–ù–õ–ê–ô–ù. –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ UI
                uiGoOnline();

                // 2. –ñ–∏–≤–∏–π –µ—Ñ—ñ—Ä
                if (status.isLiveStream) {
                    if (!isPlayingLive) {
                        console.log("Switching to LIVE...");
                        isPlayingLive = true;
                        currentTrackId = null;
                        // –î–æ–¥–∞—î–º–æ nocache, —â–æ–± –±—Ä–∞—É–∑–µ—Ä –ø–æ–±–∞—á–∏–≤ –Ω–æ–≤–∏–π —Ñ–∞–π–ª
                        loadAudioSource(status.liveUrl + "?nocache=" + Date.now(), true);
                        
                        // –ü—Ä–∏–º—É—Å–æ–≤–æ –ø–æ–∫–∞–∑—É—î–º–æ –ø–ª–µ—î—Ä, —è–∫—â–æ –≤—ñ–Ω —Å—Ö–æ–≤–∞–Ω–∏–π
                        if(overlay.style.display === 'none') {
                            container.style.display = 'block';
                        }
                    }
                    return;
                }

                // 3. –ó–≤–∏—á–∞–π–Ω–∏–π –ø–ª–µ–π–ª–∏—Å—Ç
                if (isPlayingLive) {
                    console.log("Switching back to Auto-DJ...");
                    isPlayingLive = false;
                    window.location.reload(); 
                    return;
                }

                if (status.startTrackId && status.startTrackId !== currentTrackId) {
                    var trackInfo = status.playlist.find(t => t.trackId === status.startTrackId);
                    if (trackInfo) {
                        currentTrackId = status.startTrackId;
                        trackLabel.innerText = trackInfo.title;
                        
                        if (!audio.src.includes(trackInfo.url) && (!hls || hls.url !== trackInfo.url)) {
                             loadAudioSource(trackInfo.url, false);
                             if (status.startOffset > 0) audio.currentTime = status.startOffset;
                        }
                        updateButtons(trackInfo.userRating, trackInfo.likesCount, trackInfo.dislikesCount, trackInfo.trackId);
                    }
                }

            } catch (e) { console.error(e); }
        }

        btnStart.addEventListener('click', function() {
            overlay.style.display = 'none';
            container.style.display = 'block';
            // –ü—Ä–æ–±—É—î–º–æ –≥—Ä–∞—Ç–∏, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —â–µ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å, —â–æ–± —Ä–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏ Autoplay
            audio.play().catch(e => {}); 
            checkRadioStatus(); 
        });

        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –æ–¥—Ä–∞–∑—É —ñ –ø–æ—Ç—ñ–º –∫–æ–∂–Ω—ñ 5 —Å–µ–∫
        // –¶–µ –≤–∞–∂–ª–∏–≤–æ –¥–ª—è "–≥–∞—Ä—è—á–æ–≥–æ" –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–π—à–æ–≤, –∫–æ–ª–∏ –µ—Ñ—ñ—Ä –í–ñ–ï –π–¥–µ
        checkRadioStatus();
        setInterval(checkRadioStatus, 5000);

        // --- –°—Ç–∞—Ä—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ---
        window.toggleMute = function() {
            audio.muted = !audio.muted;
            document.getElementById('muteIcon').className = audio.muted ? "bi bi-volume-mute-fill fs-4" : "bi bi-volume-up-fill fs-4";
        };

        window.rateTrack = async function(isLike) {
            if(!currentTrackId) return;
            var token = document.querySelector('#csrf-form input').value;
            try {
                let response = await fetch(`/Home/RateTrack?trackId=${currentTrackId}&isLike=${isLike}`, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': token }
                });
                if (response.status === 401) { alert("–£–≤—ñ–π–¥—ñ—Ç—å!"); return; }
                if (response.ok) {
                    let data = await response.json();
                    updateButtons(data.status, data.likes, data.dislikes, currentTrackId);
                }
            } catch (e) {}
        };

        function updateButtons(status, likes, dislikes, trackId) {
            if(btnLike) btnLike.dataset.trackId = trackId;
            if(!btnLike) return;
            btnLike.className = "rating-btn rounded-circle p-4 d-flex flex-column align-items-center justify-content-center";
            btnDislike.className = "rating-btn rounded-circle p-4 d-flex flex-column align-items-center justify-content-center";
            var iconLike = document.getElementById('iconLike');
            var iconDislike = document.getElementById('iconDislike');
            iconLike.className = "bi bi-hand-thumbs-up fs-3";
            iconDislike.className = "bi bi-hand-thumbs-down fs-3";
            if (status === 1) {
                btnLike.classList.add('btn-success');
                iconLike.className = "bi bi-hand-thumbs-up-fill fs-3";
            } else if (status === -1) {
                btnDislike.classList.add('btn-danger', 'active');
                iconDislike.className = "bi bi-hand-thumbs-down-fill fs-3";
            }
            document.getElementById('countLike').innerText = likes > 0 ? likes : "";
            document.getElementById('countDislike').innerText = dislikes > 0 ? dislikes : "";
        }
    </script>
}